<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Hybrid Shop (API + Socket)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.5s;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-light">
    <main id="app" class="container mt-5">

        <div class="toast-container">
            <transition-group name="fade">
                <div v-for="(note, index) in notifications" :key="index"
                    :class="['alert', note.type === 'error' ? 'alert-danger' : 'alert-success', 'shadow', 'mb-2']"
                    role="alert">
                    {{ note.message }}
                </div>
            </transition-group>
        </div>

        <header class="text-center mb-4">
            <h2>ðŸ›’ Hybrid Shop (API Actions + Socket Updates)</h2>
        </header>

        <section class="card mb-4 shadow-sm" aria-labelledby="email-step-label">
            <div class="card-body">
                <label id="email-step-label" class="fw-bold">Step 1: Enter Email to Sync Cart</label>
                <div class="input-group mt-2">
                    <span class="input-group-text">@</span>
                    <input type="email" v-model="userEmail" @change="syncCart" class="form-control"
                        placeholder="user@example.com">
                </div>
                <small class="text-muted">Required</small>
            </div>
        </section>

        <div class="row">
            <section class="col-md-7" aria-labelledby="products-heading">
                <h4 id="products-heading" class="mb-3">Products (Live Stock)</h4>
                
                <div class="row g-3">
                    <div class="col-md-6" v-for="product in products" :key="product.id">
                        <article class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">{{ product.name }}</h5>
                                <p class="card-text text-muted">Price: ${{ product.price }}</p>

                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span :class="['badge', product.stock <= 3 ? 'bg-danger' : 'bg-success']">
                                        Stock: {{ product.stock }}
                                    </span>
                                </div>

                                <button class="btn btn-primary w-100" :disabled="product.stock === 0"
                                    @click="addToCart(product)">
                                    {{ product.stock === 0 ? 'Out of Stock' : 'Add to Cart' }}
                                </button>
                            </div>
                        </article>
                    </div>
                </div>
            </section>

            <aside class="col-md-5" aria-labelledby="cart-heading">
                <div class="card border-0 shadow-sm p-3">
                    <header class="d-flex justify-content-between align-items-center">
                        <h4 id="cart-heading">Your Cart</h4>
                        <span class="badge bg-primary rounded-pill">{{ cartItemCount }}</span>
                    </header>
                    <hr>

                    <div v-if="cart.length === 0" class="text-center text-muted py-3">
                        Cart is empty.
                    </div>

                    <ul v-else class="list-group list-group-flush">
                        <li v-for="(item, index) in cart" :key="item.id" class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">{{ item.name }}</h6>
                                    <small class="text-muted">${{ item.price }} / unit</small>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-outline-secondary qty-btn"
                                        @click="decreaseQty(item)" aria-label="Decrease quantity">-</button>
                                    <span class="fw-bold">{{ item.quantity }}</span>
                                    <button class="btn btn-outline-primary qty-btn"
                                        @click="increaseQty(item)" aria-label="Increase quantity">+</button>
                                    <button class="btn btn-danger qty-btn ms-2"
                                        @click="removeFromCart(index)" aria-label="Remove item">x</button>
                                </div>
                            </div>
                        </li>
                    </ul>

                    <div v-if="cart.length > 0" class="mt-3">
                        <div class="d-flex justify-content-between fw-bold fs-5 mb-3">
                            <span>Total:</span>
                            <span>${{ cartTotal }}</span>
                        </div>
                        <button class="btn btn-success w-100 py-2" @click="placeOrder">
                            Checkout (API Call)
                        </button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const { createApp } = Vue;
        const socket = io();

        createApp({
            data() {
                return {
                    mySocketId: null,
                    userEmail: '',
                    products: [],
                    cart: [],
                    notifications: []
                }
            },
            computed: {
                cartTotal() {
                    return this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                },
                cartItemCount() {
                    return this.cart.reduce((sum, item) => sum + item.quantity, 0);
                }
            },
            mounted() {
                socket.on('sessionDetails', (data) => {
                    this.mySocketId = data.socketId;
                });

                socket.on('updateProducts', (data) => {
                    this.products = data;
                });

                socket.on('notification', (data) => {
                    this.showNotification(data);
                });

                this.fetchProducts();
            },
            methods: {
                async fetchProducts() {
                    try {
                        const res = await fetch('/api/cart/products');
                        this.products = await res.json();
                    } catch (err) {
                        console.error("Failed to fetch products", err);
                    }
                },

                async syncCart() {
                    try {
                        await fetch('/api/cart/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: this.userEmail,
                                cart: this.cart,
                                socketId: this.mySocketId
                            })
                        });
                    } catch (err) {
                        console.error("Sync failed", err);
                    }
                },

                async placeOrder() {
                    if (!this.userEmail) return alert("Please enter email first!");

                    try {
                        const response = await fetch('/api/cart/order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: this.userEmail,
                                cart: this.cart,
                                socketId: this.mySocketId
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.cart = [];
                            this.syncCart();
                        } else {
                            alert("Order failed: " + result.message);
                        }
                    } catch (err) {
                        console.error("Order failed", err);
                    }
                },

                addToCart(product) {
                    if (!this.userEmail) return alert("Please enter your email first to sync cart!");

                    const existingItem = this.cart.find(i => i.id === product.id);

                    if (existingItem) {
                        if (existingItem.quantity < product.stock) {
                            existingItem.quantity++;
                        } else {
                            this.showNotification({ type: 'error', message: 'Max stock reached for this item' });
                            return;
                        }
                    } else {
                        this.cart.push({ ...product, quantity: 1 });
                    }
                    this.syncCart();
                },

                increaseQty(item) {
                    const liveProduct = this.products.find(p => p.id === item.id);
                    if (liveProduct && item.quantity < liveProduct.stock) {
                        item.quantity++;
                        this.syncCart();
                    } else {
                        this.showNotification({ type: 'error', message: 'No more stock available' });
                    }
                },

                decreaseQty(item) {
                    if (item.quantity > 1) {
                        item.quantity--;
                        this.syncCart();
                    }
                },

                removeFromCart(index) {
                    this.cart.splice(index, 1);
                    this.syncCart();
                },

                showNotification(note) {
                    this.notifications.push(note);
                    setTimeout(() => this.notifications.shift(), 4000);
                }
            }
        }).mount('#app');
    </script>

</body>

</html>